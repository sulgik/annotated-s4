\PassOptionsToPackage{unicode=true}{hyperref} % options for packages loaded elsewhere
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[ignorenonframetext,]{beamer}
\usepackage{pgfpages}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}
\beamertemplatenavigationsymbolsempty
% Prevent slide breaks in the middle of a paragraph:
\widowpenalties 1 10000
\raggedbottom
\setbeamertemplate{part page}{
\centering
\begin{beamercolorbox}[sep=16pt,center]{part title}
  \usebeamerfont{part title}\insertpart\par
\end{beamercolorbox}
}
\setbeamertemplate{section page}{
\centering
\begin{beamercolorbox}[sep=12pt,center]{part title}
  \usebeamerfont{section title}\insertsection\par
\end{beamercolorbox}
}
\setbeamertemplate{subsection page}{
\centering
\begin{beamercolorbox}[sep=8pt,center]{part title}
  \usebeamerfont{subsection title}\insertsubsection\par
\end{beamercolorbox}
}
\AtBeginPart{
  \frame{\partpage}
}
\AtBeginSection{
  \ifbibliography
  \else
    \frame{\sectionpage}
  \fi
}
\AtBeginSubsection{
  \frame{\subsectionpage}
}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provides euro and other symbols
\else % if luatex or xelatex
  \usepackage{unicode-math}
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
\usetheme[]{default}
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\usepackage{hyperref}
\hypersetup{
            pdftitle={Annotated S4},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\newif\ifbibliography
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}

% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother


\title{Annotated S4}
\date{}

\begin{document}
\frame{\titlepage}

\begin{frame}

\end{frame}

\begin{frame}{Generating Extremely Long Sequences in JAX}
\protect\hypertarget{generating-extremely-long-sequences-in-jax}{}

\href{http://rush-nlp.com/}{Sasha Rush} (@srush\_nlp) with
\href{https://www.siddkaramcheti.com/}{Sidd Karamcheti}

\url{https://github.com/srush/annotated-s4}

Based on research by Albert Gu, Karan Goel, and Christopher Ré.

\end{frame}

\begin{frame}{Intro}
\protect\hypertarget{intro}{}

\end{frame}

\begin{frame}

\begin{block}{The Transformer Weakness}

\begin{figure}
\centering
\includegraphics{https://miro.medium.com/max/1400/1*YmND0Qj8O6b35J1yU_CPKQ.png}
\caption{height:300px}
\end{figure}

\begin{itemize}
\tightlist
\item
  Scales \(O(L^2)\) with length \(L\).
\end{itemize}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Recurrent Neural Networks (RNN)}

\includegraphics{https://miro.medium.com/max/1400/1*UkI9za9zTR-HL8uM15Wmzw.png}

\begin{itemize}
\tightlist
\item
  Scales \(O(L)\) with length \(L\).
\end{itemize}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Long Range Arena}

\begin{itemize}
\tightlist
\item
  A benchmark of extremely long sequence tasks (up to 16k tokens)
\end{itemize}

\begin{figure}
\centering
\includegraphics{https://d3i71xaburhd42.cloudfront.net/7e9ff94476f41041c75e253e84f487db00e9c861/6-Table1-1.png}
\caption{height:400px}
\end{figure}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Linearized Images}

\begin{figure}
\centering
\caption{height:300px}
\end{figure}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Path-X}

\begin{figure}
\centering
\includegraphics{https://pbs.twimg.com/media/FDTbF31UUAMgfei.png}
\caption{height:300px}
\end{figure}

\begin{itemize}
\tightlist
\item
  Classification problem on linearized (one pixel at a time) image
  sequence.
\end{itemize}

\end{block}

\end{frame}

\begin{frame}{Method}
\protect\hypertarget{method}{}

\end{frame}

\begin{frame}

\begin{block}{\href{https://arxiv.org/abs/2111.00396}{Efficiently
Modeling Long Sequences with Structured State Spaces}}

Albert Gu, Karan Goel, and Christopher Ré.

\includegraphics{images/hero.png}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Punchline}

\includegraphics{images/table.png}

\end{block}

\end{frame}

\begin{frame}{\href{https://srush.github.io/annotated-s4/}{The Annotated
S4}}
\protect\hypertarget{the-annotated-s4}{}

\end{frame}

\begin{frame}

\begin{block}{Image Generation}

\includegraphics{images/im0.4.png}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Speech Generation}

\begin{figure}
\centering
\includegraphics{images/speech25.0.png}
\caption{h:500px}
\end{figure}

\end{block}

\end{frame}

\begin{frame}{Part 1: SSM}
\protect\hypertarget{part-1-ssm}{}

\end{frame}

\begin{frame}[fragile]

\begin{block}{State Space Models (SSM)}

\begin{itemize}
\tightlist
\item
  A
  \href{https://en.wikipedia.org/wiki/State-space_representation}{state
  space model} maps a 1-D input signal \(u(t)\) to an \(N\)-D latent
  state \(x(t)\) before projecting to a 1-D output signal \(y(t)\).
\end{itemize}

\[
  \begin{aligned}
    x'(t) &= \boldsymbol{A}x(t) + \boldsymbol{B}u(t) \\
    y(t) &= \boldsymbol{C}x(t)\\
  \end{aligned}
\]

\begin{itemize}
\tightlist
\item
  \(\boldsymbol{A}\), \(\boldsymbol{B}\), \(\boldsymbol{C}\) are
  parameters; \(u\) input, \(y\) output, \(x\) state
\end{itemize}

\begin{verbatim}
def random_SSM(rng, N):
    a_r, b_r, c_r = jax.random.split(rng, 3)
    A = jax.random.uniform(a_r, (N, N))
    B = jax.random.uniform(b_r, (N, 1))
    C = jax.random.uniform(c_r, (1, N))
    return A, B, C
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{Discretization}

\begin{itemize}
\item
  To discretize input sequence \((u_0, u_1, \dots, u_{L-1})\) need a
  \textbf{step size} \(\Delta\) representing \(u_k = u(k \Delta)\).
\item
  One choice for discretization is a
  \href{https://en.wikipedia.org/wiki/Bilinear_transform}{bilinear
  transform}.
\end{itemize}

\[
\begin{aligned}
  \boldsymbol{\overline{A}} &= (\boldsymbol{I} - \Delta/2 \cdot \boldsymbol{A})^{-1}(\boldsymbol{I} + \Delta/2 \cdot \boldsymbol{A}) \\
  \boldsymbol{\overline{B}} &= (\boldsymbol{I} - \Delta/2 \cdot \boldsymbol{A})^{-1} \Delta \boldsymbol{B} \\
  \boldsymbol{\overline{C}} &= \boldsymbol{C}\\
\end{aligned}
\]

\begin{verbatim}
def discretize(A, B, C, step):
    I = np.eye(A.shape[0])
    BL = inv(I - (step / 2.0) * A)
    Ab = BL @ (I + (step / 2.0) * A)
    Bb = (BL * step) @ B
    return Ab, Bb, C
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{Discretized SSM as RNN}

\begin{itemize}
\tightlist
\item
  Once discretized with step \(\Delta\), the SSM can be viewed as a
  linear RNN,
\end{itemize}

\[
\begin{aligned}
  x_{k} &= \boldsymbol{\overline{A}} x_{k-1} + \boldsymbol{\overline{B}} u_k\\
  y_k &= \boldsymbol{\overline{C}} x_k \\
\end{aligned}
\]

\begin{verbatim}
def scan_SSM(Ab, Bb, Cb, u, x0):
    def step(x_k_1, u_k):
        x_k = Ab @ x_k_1 + Bb @ u_k
        y_k = Cb @ x_k
        return x_k, y_k

    return jax.lax.scan(step, x0, u)
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{Tangent: A Mechanics Example}

\begin{itemize}
\item
  \href{https://en.wikipedia.org/wiki/State-space_representation\#Moving_object_example}{Example
  from mechanics}, mass on a spring

  \begin{itemize}
  \tightlist
  \item
    forward position \(y(t)\)
  \item
    force \(u(t)\) is applied to this mass
  \item
    parameterized by mass (\(m\)), spring constant (\(k\)), friction
    constant (\(b\))
  \end{itemize}
\end{itemize}

\[
\begin{aligned}
my''(t) = u(t) - by'(t) - ky(t)
\end{aligned}
\]

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{Tangent: A Mechanics Example {[}Matrix form{]}}

\[
\begin{aligned}
my''(t) = u(t) - by'(t) - ky(t)
\end{aligned}
\]

\[
\begin{aligned}
\boldsymbol{A} &= \begin{bmatrix} 0 & 1 \\ -k/m & -b/m \end{bmatrix}  \\
\boldsymbol{B} & = \begin{bmatrix} 0  \\ 1/m \end{bmatrix} & \boldsymbol{C} = \begin{bmatrix} 1 & 0  \end{bmatrix}  \\
\end{aligned}
\]

\begin{verbatim}
def example_mass(k, b, m):
    A = np.array([[0, 1], [-k / m, -b / m]])
    B = np.array([[0], [1.0 / m]])
    C = np.array([[1.0, 0]])
    return A, B, C
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{Tangent: A Mechanics Example (with force)}

\begin{verbatim}
@partial(np.vectorize, signature="()->()")
def example_force(t):
    x = np.sin(10 * t)
    return x * (x > 0.5)
\end{verbatim}

\begin{verbatim}
def example_ssm(L=100):
    ssm = example_mass(k=40, b=5, m=1)

    # L samples of u(t).
    step = 1.0 / L
    ks = np.arange(L)
    u = example_force(ks * step)
    y = scan_SSM(*ssm, u)
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}

\includegraphics{images/line.gif}

\end{frame}

\begin{frame}

\begin{block}{Training SSMs}

\begin{itemize}
\tightlist
\item
  Our Goal: Train a neural network with SSMs
\item
  SSM RNNs: Fast for generation, but slow for training
\end{itemize}

\begin{block}{Key Properties}

\begin{itemize}
\tightlist
\item
  SSM CNNs: Slow for generation, but fast for training
\item
  Initilization
\end{itemize}

\end{block}

\end{block}

\end{frame}

\begin{frame}

\begin{block}{SSMs as wide CNNs}

\begin{enumerate}
\tightlist
\item
  ``Unroll'' the RNN representation
\end{enumerate}

\[
\begin{aligned}
  x_{k} &= \boldsymbol{\overline{A}} x_{k-1} + \boldsymbol{\overline{B}} u_k\\
  y_k &= \boldsymbol{\overline{C}} x_k \\
\end{aligned}
\]

\[
\begin{aligned}
  x_0 &= \boldsymbol{\overline{B}} u_0 &
  x_1 &= \boldsymbol{\overline{A}} \boldsymbol{\overline{B}} u_0 + \boldsymbol{\overline{B}} u_1 &
  x_2 &= \boldsymbol{\overline{A}}^2 \boldsymbol{\overline{B}} u_0 + \boldsymbol{\overline{A}} \boldsymbol{\overline{B}} u_1 + \boldsymbol{\overline{B}} u_2 & \dots
  \\
  y_0 &= \boldsymbol{\overline{C}} \boldsymbol{\overline{B}} u_0 &
  y_1 &= \boldsymbol{\overline{C}} \boldsymbol{\overline{A}} \boldsymbol{\overline{B}} u_0 + \boldsymbol{\overline{C}} \boldsymbol{\overline{B}} u_1 &
  y_2 &= \boldsymbol{\overline{C}} \boldsymbol{\overline{A}}^2 \boldsymbol{\overline{B}} u_0 + \boldsymbol{\overline{C}} \boldsymbol{\overline{A}} \boldsymbol{\overline{B}} u_1 + \boldsymbol{\overline{C}} \boldsymbol{\overline{B}} u_2
  & \dots
\end{aligned}
\]

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{SSMs as wide CNNs}

\begin{enumerate}
\setcounter{enumi}{1}
\tightlist
\item
  Form a \(L\)-length kernel
\end{enumerate}

\[
\begin{aligned}
    y_k &= \boldsymbol{\overline{C}} \boldsymbol{\overline{A}}^k \boldsymbol{\overline{B}} u_0 + \boldsymbol{\overline{C}} \boldsymbol{\overline{A}}^{k-1} \boldsymbol{\overline{B}} u_1 + \dots + \boldsymbol{\overline{C}} \boldsymbol{\overline{A}} \boldsymbol{\overline{B}} u_{k-1} + \boldsymbol{\overline{C}}\boldsymbol{\overline{B}} u_k
    \\
\end{aligned}
\] \textgreater{} \[
\begin{aligned}
  \boldsymbol{\overline{K}} \in \mathbb{R}^L  = (\boldsymbol{\overline{C}}\boldsymbol{\overline{B}}, \boldsymbol{\overline{C}}\boldsymbol{\overline{A}}\boldsymbol{\overline{B}}, \dots, \boldsymbol{\overline{C}}\boldsymbol{\overline{A}}^{L-1}\boldsymbol{\overline{B}})
\end{aligned}
\]

\begin{verbatim}
def K_conv(Ab, Bb, Cb, L):
    return np.array(
        [(Cb @ matrix_power(Ab, l) @ Bb).reshape() for l in range(L)]
    )
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{SSMs as wide CNNs}

\begin{enumerate}
\setcounter{enumi}{2}
\tightlist
\item
  Apply as a (non-cicular) convolution
\end{enumerate}

\[
y = \boldsymbol{\overline{K}} \ast u
\]

\begin{verbatim}
def non_circular_convolution(u, K, nofft=False):
    if nofft:
        return convolve(u, K, mode="full")[: u.shape[0]]
    else:
        ud = np.fft.rfft(np.pad(u, (0, K.shape[0])))
        Kd = np.fft.rfft(np.pad(K, (0, u.shape[0])))
        return np.fft.irfft(ud * Kd)[: u.shape[0]]
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \(O(L \log L)\) training through FFT
\end{itemize}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{Initialization with
\href{https://arxiv.org/abs/2008.07669}{HiPPO}}

\begin{itemize}
\tightlist
\item
  Fast training, but random init does terribly. MNIST classification
  benchmark \(50\%\).
\item
  HiPPO initialization of \(\mathbf{A}\) improves this number to
  \(98\%\)
\end{itemize}

\begin{verbatim}
def make_HiPPO(N):
    def v(n, k):
        if n > k:
            return np.sqrt(2 * n + 1) * np.sqrt(2 * k + 1)
        elif n == k:
            return n + 1
        else:
            return 0
    mat = [[v(n, k) for k in range(1, N + 1)] for n in range(1, N + 1)]
    return -np.array(mat)
\end{verbatim}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}{HiPPO Intuition Sketch}

\begin{itemize}
\tightlist
\item
  Recall \(x_k\) is an \(N\)-dimensional hidden representation of an
  \(L\)-step signal
\item
  HiPPO approximates state as \(N\) Legendre coefficients representing
  \(u\).
\end{itemize}

\begin{figure}
\centering
\includegraphics{images/leg.png}
\caption{h:300px}
\end{figure}

\begin{verbatim}
def example_legendre(N=8):
    u = (np.random.rand(N) - 0.5) * 2
    t = np.linspace(-1, 1, 100)
    x = numpy.polynomial.legendre.Legendre(u)(t)
\end{verbatim}

\end{block}

\end{frame}

\end{document}
